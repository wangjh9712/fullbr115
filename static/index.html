<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fullbr115 Media</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        emby: {
                            dark: '#141414',
                            card: '#1f1f1f',
                            accent: '#00a4dc',
                            green: '#52b54b',
                            red: '#e50914',
                            gold: '#ffd700'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        [v-cloak] { display: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        /* ISO 哑光黑金风格 */
        .iso-black-gold {
            background: linear-gradient(145deg, #3a3a3a 0%, #1f1f1f 100%);
            border: 1px solid rgba(255, 215, 0, 0.4);
            color: #e0e0e0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        .iso-black-gold::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.4), transparent);
        }
        .iso-black-gold:hover {
            border-color: rgba(255, 215, 0, 0.7);
            background: linear-gradient(145deg, #454545 0%, #2a2a2a 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .iso-text-gold {
            color: #ffd700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-emby-dark text-gray-900 dark:text-gray-100 transition-colors duration-300 font-sans">

<script type="text/x-template" id="tree-node-template">
    <div class="ml-0">
        <div class="flex items-center py-2 px-2 group transition-all cursor-pointer border-b border-gray-200 dark:border-gray-700/50"
             :class="[
                 isISO ? 'iso-black-gold rounded my-1 border-0' : 'hover:bg-gray-50 dark:hover:bg-gray-700/50',
                 isRoot ? 'bg-gray-50 dark:bg-gray-800 rounded-t-lg' : ''
             ]"
             @click="toggle">
            
            <span v-if="item.is_dir && !isISO" class="mr-2 w-4 text-center text-gray-400 hover:text-emby-accent transition-transform duration-200"
                  :class="{'rotate-90': isOpen}">
                <i class="fa-solid fa-caret-right"></i>
            </span>
            <span v-else class="mr-2 w-4"></span>

            <div class="mr-3 text-lg flex-shrink-0">
                <i v-if="isISO" class="fa-solid fa-compact-disc iso-text-gold"></i>
                <i v-else-if="item.is_dir" class="fa-solid text-yellow-500" 
                   :class="isOpen ? 'fa-folder-open' : 'fa-folder'"></i>
                <i v-else class="fa-solid fa-file-video text-blue-400"></i>
            </div>
            
            <div class="flex-1 min-w-0 pr-4">
                <div class="flex items-center flex-wrap gap-2">
                    <span class="truncate font-medium select-none text-sm" :class="isISO ? 'iso-text-gold' : ''">
                        {{ item.name }}
                    </span>
                    <div v-if="item.extraTags && item.extraTags.length" class="flex space-x-1">
                        <span v-for="tag in item.extraTags" :key="tag" 
                              class="px-1.5 py-0.5 rounded text-[10px] bg-gray-200 dark:bg-gray-600/50 text-gray-600 dark:text-gray-300 border border-transparent"
                              :class="isISO ? '!bg-yellow-900/30 !text-yellow-200 !border-yellow-600/30' : ''">
                            {{ tag }}
                        </span>
                    </div>
                </div>
            </div>

            <span class="text-xs text-gray-500 dark:text-gray-400 mr-4 font-mono hidden sm:block whitespace-nowrap" :class="isISO ? '!text-gray-300' : ''">
                {{ formatBytes(item.size) }}
            </span>

            <button @click.stop="onSave" 
                    class="p-2 rounded-full text-gray-400 hover:text-white hover:bg-emby-green transition shadow-sm" 
                    title="转存到网盘">
                <i class="fa-solid fa-cloud-arrow-up"></i>
            </button>
        </div>

        <div v-if="isOpen" class="pl-4 md:pl-6 border-l border-gray-200 dark:border-gray-700 ml-3">
            <div v-if="loading" class="py-2 text-xs text-gray-500 flex items-center">
                <i class="fa-solid fa-spinner fa-spin mr-2"></i> 加载中...
            </div>
            <template v-else>
                <tree-node v-for="child in children" 
                    :key="child.id" 
                    :item="child" 
                    :share-link="shareLink"
                    :password="password"
                    @notify="$emit('notify', $event)"
                ></tree-node>
            </template>
        </div>
    </div>
</script>

<div id="app" v-cloak class="min-h-screen flex flex-col relative overflow-x-hidden">

    <div class="fixed top-20 right-5 z-[100] space-y-3 w-80 pointer-events-none">
        <div v-for="toast in toasts" :key="toast.id" 
             class="flex items-start p-4 rounded-lg shadow-lg text-white transform transition-all duration-300 pointer-events-auto backdrop-blur-md"
             :class="toast.type === 'success' ? 'bg-emby-green/90' : 'bg-red-500/90'">
            <i class="fa-solid mt-1 mr-3" :class="toast.type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'"></i>
            <div class="flex-1 text-sm break-words font-medium">{{ toast.message }}</div>
            <button @click="removeToast(toast.id)" class="ml-2 hover:text-gray-200"><i class="fa-solid fa-times"></i></button>
        </div>
    </div>

    <nav class="sticky top-0 z-50 bg-white/90 dark:bg-black/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center cursor-pointer" @click="goHome">
                    <i class="fa-solid fa-play-circle text-3xl text-emby-accent mr-2"></i>
                    <span class="font-bold text-xl tracking-wide">Fullbr<span class="text-emby-green">115</span></span>
                </div>
                
                <div class="hidden md:flex flex-1 max-w-lg mx-8">
                    <div class="relative w-full">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i class="fa-solid fa-search text-gray-400"></i>
                        </span>
                        <input type="text" v-model="searchQuery" @keyup.enter="performSearch"
                            class="w-full bg-gray-100 dark:bg-gray-800 rounded-full py-2 pl-10 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-emby-accent transition"
                            placeholder="搜索电影、剧集...">
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <button class="md:hidden p-2" @click="showMobileSearch = !showMobileSearch">
                        <i class="fa-solid fa-search"></i>
                    </button>
                    <button @click="toggleTheme" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                        <i class="fa-solid" :class="isDark ? 'fa-sun text-yellow-400' : 'fa-moon text-gray-600'"></i>
                    </button>
                </div>
            </div>
            
            <div v-if="showMobileSearch" class="md:hidden pb-4">
                <input type="text" v-model="searchQuery" @keyup.enter="performSearch"
                    class="w-full bg-gray-100 dark:bg-gray-800 rounded-lg py-2 px-4 text-sm focus:outline-none focus:ring-2 focus:ring-emby-accent"
                    placeholder="搜索...">
            </div>
        </div>
    </nav>

    <main class="flex-grow">
        
        <div v-if="currentView === 'home' || currentView === 'search'" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            
            <div v-if="currentView === 'home'" class="mb-8 space-y-4">
                <div class="flex items-center space-x-6 border-b border-gray-200 dark:border-gray-800 pb-2">
                    <button v-for="type in ['movie', 'tv']" :key="type"
                        @click="switchMediaType(type)"
                        class="text-lg font-medium px-2 py-1 border-b-2 transition-colors duration-200"
                        :class="mediaType === type ? 'border-emby-accent text-emby-accent' : 'border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'">
                        {{ type === 'movie' ? '电影' : '剧集' }}
                    </button>
                </div>

                <div class="bg-white dark:bg-emby-card rounded-xl shadow-sm p-4 text-sm">
                    <div class="flex flex-wrap gap-4 items-center justify-between">
                        <div class="flex flex-wrap gap-3 items-center w-full lg:w-auto">
                            <select v-model="filters.sortBy" @change="refreshData" 
                                class="bg-gray-100 dark:bg-gray-800 rounded px-3 py-1.5 outline-none border border-transparent focus:border-emby-accent">
                                <option value="popularity.desc">最热门</option>
                                <option value="vote_average.desc">最高评分</option>
                                <option value="primary_release_date.desc">最新上映</option>
                            </select>

                            <div class="flex items-center space-x-2 bg-gray-100 dark:bg-gray-800 rounded px-3 py-1.5">
                                <span class="text-gray-500">评分 ></span>
                                <input type="number" v-model.number="filters.minVote" min="0" max="10" step="0.5" @change="refreshData"
                                    class="w-12 bg-transparent text-center outline-none">
                            </div>

                             <div class="hidden sm:flex items-center space-x-2 bg-gray-100 dark:bg-gray-800 rounded px-3 py-1.5">
                                <span class="text-gray-500">评分人数 ></span>
                                <input type="number" v-model.number="filters.minVoteCount" step="100" @change="refreshData"
                                    class="w-16 bg-transparent text-center outline-none">
                            </div>
                        </div>

                        <button @click="showAdvancedFilters = !showAdvancedFilters" class="text-emby-accent text-sm hover:underline">
                            {{ showAdvancedFilters ? '收起筛选' : '更多筛选' }}
                        </button>
                    </div>

                    <div v-show="showAdvancedFilters" class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 space-y-4">
                        <div>
                            <span class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">年份</span>
                            <div class="flex flex-wrap gap-2">
                                <button v-for="range in dateRanges" :key="range.label"
                                    @click="toggleDateRange(range)"
                                    class="px-3 py-1 rounded-full text-xs transition border"
                                    :class="filters.dateRange?.label === range.label ? 'bg-emby-accent text-white border-emby-accent' : 'bg-transparent border-gray-300 dark:border-gray-600 hover:border-emby-accent'">
                                    {{ range.label }}
                                </button>
                                <button @click="filters.dateRange = null; refreshData()" class="px-3 py-1 text-xs text-gray-500 hover:text-emby-accent">
                                    清除
                                </button>
                            </div>
                        </div>

                        <div>
                            <span class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">地区/语言</span>
                            <div class="flex flex-wrap gap-2">
                                <button v-for="lang in languageOptions" :key="lang.code"
                                    @click="toggleLanguage(lang.code)"
                                    class="px-3 py-1 rounded-full text-xs transition border"
                                    :class="filters.originalLanguage === lang.code ? 'bg-emby-accent text-white border-emby-accent' : 'bg-transparent border-gray-300 dark:border-gray-600 hover:border-emby-accent'">
                                    {{ lang.label }}
                                </button>
                                <button @click="filters.originalLanguage = null; refreshData()" class="px-3 py-1 text-xs text-gray-500 hover:text-emby-accent">
                                    清除
                                </button>
                            </div>
                        </div>

                        <div>
                            <span class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">类型</span>
                            <div class="flex flex-wrap gap-2 max-h-32 overflow-y-auto custom-scrollbar">
                                <button v-for="g in genres" :key="g.id"
                                    @click="toggleGenre(g.id)"
                                    class="px-3 py-1 rounded-full text-xs transition border"
                                    :class="filters.selectedGenres.includes(g.id) ? 'bg-emby-green text-white border-emby-green' : 'bg-transparent border-gray-300 dark:border-gray-600 hover:border-emby-green'">
                                    {{ g.name }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'search'" class="mb-6 flex items-center justify-between">
                <button @click="goHome" class="flex items-center text-gray-600 dark:text-gray-300 hover:text-emby-accent transition">
                    <i class="fa-solid fa-arrow-left mr-2"></i> 返回发现页
                </button>
                <div class="text-sm text-gray-500">搜索结果: "{{ searchQuery }}"</div>
            </div>

            <div v-if="loading" class="flex justify-center py-20">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-emby-accent"></i>
            </div>
            
            <div v-else-if="mediaList.length === 0" class="text-center py-20 text-gray-500">
                <i class="fa-solid fa-film text-6xl mb-4 opacity-30"></i>
                <p>没有找到相关内容</p>
            </div>

            <div v-else class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-6">
                <div v-for="item in mediaList" :key="item.tmdb_id" 
                    class="group relative cursor-pointer flex flex-col transition-transform duration-300 hover:scale-105"
                    @click="goToDetail(item.tmdb_id, item.media_type)">
                    
                    <div class="relative w-full aspect-[2/3] rounded-lg overflow-hidden shadow-lg bg-gray-200 dark:bg-gray-800">
                        <img :src="item.poster_path || 'https://via.placeholder.com/300x450?text=No+Image'" 
                             class="w-full h-full object-cover transition duration-500 group-hover:brightness-110"
                             loading="lazy">
                        <div class="absolute top-2 right-2 bg-black/70 text-white text-xs font-bold px-1.5 py-0.5 rounded backdrop-blur-sm">
                            {{ item.vote_average.toFixed(1) }}
                        </div>
                    </div>

                    <div class="mt-2 px-1">
                        <h3 class="text-sm font-bold truncate text-gray-800 dark:text-gray-100 group-hover:text-emby-accent transition-colors">
                            {{ item.title }}
                        </h3>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                            {{ item.release_date ? item.release_date.split('-')[0] : '' }}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 flex justify-center space-x-4" v-if="mediaList.length > 0">
                <button @click="changePage(-1)" :disabled="currentPage === 1" class="px-3 py-1 bg-white dark:bg-emby-card rounded shadow disabled:opacity-50">上一页</button>
                <span class="px-3 py-1 font-mono">P{{ currentPage }}</span>
                <button @click="changePage(1)" class="px-3 py-1 bg-white dark:bg-emby-card rounded shadow">下一页</button>
            </div>
        </div>

        <div v-if="currentView === 'detail' && detailData" class="relative min-h-[calc(100vh-64px)] pb-20 animate-fade-in">
            
            <div class="absolute inset-0 z-0 overflow-hidden h-[70vh]">
                <img :src="detailData.backdrop_path || detailData.poster_path" 
                     class="w-full h-full object-cover blur-md opacity-30 dark:opacity-20">
                <div class="absolute inset-0 bg-gradient-to-b from-transparent via-gray-100/60 to-gray-100 dark:via-emby-dark/80 dark:to-emby-dark"></div>
            </div>

            <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <button @click="goBack" class="mb-6 flex items-center text-gray-600 dark:text-gray-300 hover:text-emby-accent transition">
                    <i class="fa-solid fa-arrow-left mr-2"></i> 返回
                </button>

                <div class="flex flex-col md:flex-row gap-8 mb-10">
                    <div class="flex-shrink-0 w-48 md:w-64 mx-auto md:mx-0">
                        <div class="aspect-[2/3] rounded-lg shadow-2xl overflow-hidden border border-white/10">
                            <img :src="currentSeasonData?.poster_path || detailData.poster_path" class="w-full h-full object-cover">
                        </div>
                    </div>

                    <div class="flex-1 text-center md:text-left space-y-4">
                        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">{{ detailData.title }}</h1>
                        <p class="text-lg text-gray-500 font-serif italic">{{ detailData.original_title }}</p>
                        
                        <div class="flex flex-wrap items-center justify-center md:justify-start gap-3 text-sm">
                            <span class="bg-emby-accent text-white px-2 py-0.5 rounded font-bold">TMDB {{ detailData.vote_average.toFixed(1) }}</span>
                            <span class="text-gray-600 dark:text-gray-300">{{ detailData.release_date }}</span>
                            <span v-if="detailData.status" class="px-2 py-0.5 border border-gray-400 rounded text-xs">{{ detailData.status }}</span>
                        </div>

                        <p class="text-gray-700 dark:text-gray-300 leading-relaxed line-clamp-4">{{ detailData.overview }}</p>
                        
                        <div class="flex flex-wrap gap-2 justify-center md:justify-start pt-2">
                            <span v-for="g in detailData.genres" :key="g.id" class="px-2 py-0.5 bg-gray-200 dark:bg-gray-700 rounded text-xs">
                                {{ g.name }}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="mb-10 animate-slide-up" v-if="detailData.media_type === 'movie' || detailData.media_type === 'tv'">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fa-solid fa-layer-group text-emby-accent mr-2"></i>
                        {{ detailData.media_type === 'movie' ? '电影资源' : '全集/打包资源' }}
                    </h2>
                    
                    <resource-panel 
                        :tmdb-id="detailData.tmdb_id" 
                        :media-type="detailData.media_type" 
                        :availability="detailData.availability"
                        :injected-115="detailData.media_type === 'tv' ? fullSeries115 : null"
                        context="main"
                        @notify="showToast"
                    ></resource-panel>
                </div>

                <div v-if="detailData.media_type === 'tv' && detailData.seasons.length > 0" class="mb-10 animate-slide-up">
                    <h2 class="text-xl font-bold mb-6 px-2 border-l-4 border-emby-accent">分季详情</h2>
                    
                    <div ref="seasonTabsContainer" class="flex overflow-x-auto space-x-4 pb-4 mb-4 hide-scrollbar scroll-smooth">
                        <button v-for="season in detailData.seasons" :key="season.id"
                            :ref="el => seasonTabsRefs[season.season_number] = el"
                            @click="selectSeason(season)"
                            class="flex-shrink-0 px-4 py-2 rounded-lg transition text-sm font-bold whitespace-nowrap"
                            :class="selectedSeasonNumber === season.season_number 
                                ? 'bg-emby-accent text-white shadow-lg scale-105' 
                                : 'bg-gray-200 dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-300 dark:hover:bg-gray-700'">
                            {{ season.name }}
                        </button>
                    </div>

                    <div v-if="currentSeasonData" class="animate-fade-in">
                         <div class="mb-6">
                            <h4 class="text-sm font-bold text-gray-500 mb-2 uppercase tracking-wider">本季资源 (Season Pack)</h4>
                            <resource-panel 
                                :tmdb-id="detailData.tmdb_id" 
                                :season-number="currentSeasonData.season_number"
                                media-type="tv_season"
                                :availability="detailData.availability"
                                :injected-115="getCurrentSeason115(currentSeasonData.season_number)"
                                context="season"
                                @notify="showToast"
                            ></resource-panel>
                        </div>

                        <div class="mb-4 text-sm text-gray-500 dark:text-gray-400 flex items-center">
                            <span>{{ currentSeasonData.air_date }}</span>
                            <span class="mx-2">|</span>
                            <span>共 {{ currentSeasonData.episode_count }} 集</span>
                        </div>

                        <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
                            <div v-for="ep in currentSeasonData.episodes" :key="ep.id"
                                @click="openEpisodeModal(currentSeasonData.season_number, ep)"
                                class="cursor-pointer group flex bg-white/50 dark:bg-gray-800/50 rounded-lg p-3 hover:bg-white dark:hover:bg-gray-800 transition shadow-sm border border-transparent hover:border-emby-accent/50">
                                <div class="w-32 flex-shrink-0 mr-4 relative rounded overflow-hidden aspect-video bg-gray-900">
                                    <img :src="ep.still_path || detailData.backdrop_path" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                                    <div class="absolute bottom-1 right-1 bg-black/60 text-white text-[10px] px-1 rounded">
                                        {{ ep.vote_average.toFixed(1) }}
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-bold text-sm truncate pr-2 group-hover:text-emby-accent">
                                            {{ ep.episode_number }}. {{ ep.name }}
                                        </h4>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">{{ ep.air_date }}</p>
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-2 line-clamp-2">
                                        {{ ep.overview || '暂无简介' }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-else class="py-10 text-center">
                        <i class="fa-solid fa-spinner fa-spin text-2xl text-emby-accent"></i> 
                        <span class="ml-2 text-sm text-gray-500">加载季信息...</span>
                    </div>
                </div>

                 <div class="mt-16 border-t border-gray-200 dark:border-gray-800 pt-8" v-if="detailData.recommendations && detailData.recommendations.length">
                    <h2 class="text-xl font-bold mb-6">相关推荐</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-6 gap-4">
                        <div v-for="rec in detailData.recommendations" :key="rec.tmdb_id"
                            @click="goToDetail(rec.tmdb_id, rec.media_type)"
                            class="cursor-pointer group">
                            <div class="aspect-[2/3] rounded bg-gray-800 overflow-hidden mb-2 relative">
                                <img :src="rec.poster_path || 'https://via.placeholder.com/300x450'" class="w-full h-full object-cover group-hover:scale-110 transition duration-300">
                                <div class="absolute top-1 right-1 bg-black/60 text-white text-[10px] px-1 rounded">{{ rec.vote_average.toFixed(1) }}</div>
                            </div>
                            <p class="text-xs text-center truncate group-hover:text-emby-accent transition-colors">{{ rec.title }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showEpisodeModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" @click="closeEpisodeModal"></div>
            <div class="relative bg-white dark:bg-emby-card w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden animate-slide-up flex flex-col max-h-[80vh]">
                
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800">
                    <div>
                        <h3 class="text-lg font-bold">
                            S{{ currentEpisode.season_number }} E{{ currentEpisode.episode_number }} - {{ currentEpisode.name }}
                        </h3>
                        <p class="text-xs text-gray-500">{{ currentEpisode.air_date }}</p>
                    </div>
                    <button @click="closeEpisodeModal" class="text-gray-400 hover:text-gray-900 dark:hover:text-white text-xl">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <div class="p-0 overflow-y-auto custom-scrollbar flex-1">
                    <div class="p-4 bg-gray-100 dark:bg-black/20 text-sm text-gray-600 dark:text-gray-300 mb-4" v-if="currentEpisode.overview">
                        {{ currentEpisode.overview }}
                    </div>

                    <div class="px-4 pb-6">
                        <h4 class="text-sm font-bold text-gray-500 mb-3 uppercase tracking-wider">单集资源</h4>
                        <resource-panel 
                            :tmdb-id="detailData.tmdb_id" 
                            :season-number="currentEpisode.season_number"
                            :episode-number="currentEpisode.episode_number"
                            media-type="tv_episode"
                            :availability="detailData.availability"
                            context="episode"
                            @notify="showToast"
                        ></resource-panel>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<template id="resource-panel-template">
    <div class="bg-gray-100 dark:bg-gray-800/50 rounded-lg p-1">
        <div class="flex space-x-1 mb-2 border-b border-gray-200 dark:border-gray-700 pb-1 overflow-x-auto hide-scrollbar" 
             v-if="mediaType !== 'tv_episode' && tabs.length > 0">
            <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id" 
                class="px-3 py-1.5 text-sm font-medium rounded-md transition whitespace-nowrap"
                :class="activeTab === tab.id ? 'bg-white dark:bg-gray-700 text-emby-accent shadow-sm' : 'text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'">
                <i :class="tab.icon" class="mr-1"></i> {{ tab.label }}
            </button>
        </div>

        <div class="relative min-h-[100px] max-h-[300px] overflow-y-auto custom-scrollbar p-2 transition-all duration-300"
             :class="{ 'blur-sm opacity-60 pointer-events-none': loading }">
            
            <div v-if="mediaType !== 'tv_episode' && tabs.length === 0 && !loading" class="text-center py-6 text-gray-500">
                <i class="fa-solid fa-ban text-2xl mb-2 opacity-50"></i><p class="text-xs">暂无可用资源</p>
            </div>

            <div v-else-if="displayResources.length === 0 && !loading" class="text-center py-6 text-xs text-gray-500">
                该类型下暂无数据
            </div>

            <div v-else class="space-y-2">
                <template v-if="activeTab === '115_share'">
                    <div v-for="(res, idx) in displayResources" :key="idx" class="rounded overflow-hidden mb-2">
                        <tree-node 
                            :item="{ 
                                name: res.title, 
                                is_dir: true, 
                                id: '0', 
                                size: res.size,
                                extraTags: [res.resolution, res.has_chinese_subtitle?'中字':null, res.season_tag].filter(Boolean)
                            }"
                            :share-link="res.link"
                            :is-root="true" 
                            @notify="$emit('notify', $event)"
                        ></tree-node>
                    </div>
                </template>
                
                <template v-else>
                    <div v-for="(res, idx) in displayResources" :key="idx" 
                         class="p-3 rounded transition flex flex-col sm:flex-row gap-2 sm:items-center"
                         :class="isIso(res) ? 'iso-black-gold' : 'bg-white dark:bg-gray-700/50 hover:bg-gray-50 dark:hover:bg-gray-700'">
                        
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center mb-1">
                                <span v-if="mediaType === 'tv_episode'" class="text-[10px] px-1.5 py-0.5 rounded mr-2 flex-shrink-0 font-bold"
                                    :class="res.link_type === 'magnet' ? 'bg-red-500/10 text-red-500' : 'bg-blue-500/10 text-blue-500'">
                                    {{ res.link_type === 'magnet' ? 'MAG' : 'ED2K' }}
                                </span>

                                <span class="text-sm font-medium truncate" 
                                      :class="isIso(res) ? 'iso-text-gold' : 'text-gray-800 dark:text-gray-200'" 
                                      :title="res.title">{{ res.title }}</span>
                            </div>
                            
                            <div class="flex flex-wrap gap-1.5 mt-1 opacity-90">
                                <span v-if="res.season_tag" class="text-[10px] px-1.5 py-0.5 rounded bg-emby-green/10 text-emby-green border border-emby-green/30 font-medium">
                                    {{ res.season_tag }}
                                </span>

                                <span v-if="res.size" class="text-[10px] px-1.5 py-0.5 rounded"
                                    :class="isIso(res) ? 'bg-white/10 text-gray-300 border border-white/20' : 'bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300'">
                                    {{ res.size }}
                                </span>
                                <span v-if="res.resolution" class="text-[10px] px-1.5 py-0.5 rounded border"
                                    :class="isIso(res) ? 'bg-blue-900/30 text-blue-300 border-blue-500/50' : 'bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 border-blue-200 dark:border-blue-800'">
                                    {{ res.resolution }}
                                </span>
                                 <span v-if="res.quality" class="text-[10px] px-1.5 py-0.5 rounded"
                                     :class="isIso(res) ? 'bg-purple-900/50 text-purple-200' : 'bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-300'">
                                    {{ res.quality }}
                                </span>
                            </div>
                        </div>

                        <div class="flex-shrink-0 ml-auto flex items-center space-x-2">
                             <button @click="addOfflineTask(res.link)" 
                                    class="p-2 rounded-full text-gray-400 hover:text-white hover:bg-emby-green transition shadow-sm"
                                    title="离线下载">
                                <i class="fa-solid fa-cloud-download-alt"></i>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <div v-if="loading" class="absolute inset-0 z-10 flex items-center justify-center pointer-events-none">
             <i class="fa-solid fa-spinner fa-spin text-2xl text-emby-accent"></i>
        </div>
    </div>
</template>

<script>
    const { createApp, ref, computed, onMounted, watch, nextTick, defineComponent } = Vue;

    // --- Utility: Format Bytes ---
    const formatBytes = (bytes, decimals = 2) => {
        if (bytes === null || bytes === undefined) return '';
        // 修正：如果 bytes 已经是包含单位的字符串（如 "77 GB"），则直接返回，不再解析
        if (typeof bytes === 'string' && /[a-zA-Z]/.test(bytes)) return bytes;
        
        const parsed = parseInt(bytes);
        if (isNaN(parsed)) return bytes || ''; 
        if (parsed === 0) return '0 B';
        
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
        const i = Math.floor(Math.log(parsed) / Math.log(k));
        return `${parseFloat((parsed / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    };

    // --- Component: Tree Node (For 115) ---
    const TreeNode = defineComponent({
        name: 'TreeNode',
        template: '#tree-node-template',
        props: {
            item: Object, 
            shareLink: String,
            password: { type: String, default: '' },
            isRoot: { type: Boolean, default: false }
        },
        emits: ['notify'],
        setup(props, { emit }) {
            const isOpen = ref(false);
            const loading = ref(false);
            const children = ref([]);

            const isISO = computed(() => {
                return props.item.name && props.item.name.toLowerCase().endsWith('.iso');
            });

            const toggle = async () => {
                if (props.item.is_dir && !isISO.value) {
                    if (isOpen.value) {
                        isOpen.value = false;
                    } else {
                        isOpen.value = true;
                        if (children.value.length === 0) {
                            await fetchChildren();
                        }
                    }
                }
            };

            const fetchChildren = async () => {
                loading.value = true;
                try {
                    const res = await fetch('/p115/share/list', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            share_link: props.shareLink,
                            cid: props.item.id,
                            password: props.password
                        })
                    });
                    const json = await res.json();
                    if (json.state) {
                        let list = json.data.list;
                        
                        // 智能展平逻辑：如果是根节点且只有一个子文件夹，则自动获取该子文件夹的内容
                        if (props.isRoot && list.length === 1 && list[0].is_dir) {
                            const subRes = await fetch('/p115/share/list', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    share_link: props.shareLink,
                                    cid: list[0].id, 
                                    password: props.password
                                })
                            });
                            const subJson = await subRes.json();
                            if (subJson.state) {
                                list = subJson.data.list;
                            }
                        }
                        children.value = list;
                    } else {
                        emit('notify', { message: '加载目录失败: ' + json.message, type: 'error' });
                        isOpen.value = false;
                    }
                } catch (e) {
                    emit('notify', { message: '网络请求错误', type: 'error' });
                    isOpen.value = false;
                } finally {
                    loading.value = false;
                }
            };

            const onSave = async () => {
                try {
                    emit('notify', { message: '正在提交转存任务...', type: 'success' }); 
                    const res = await fetch('/p115/share/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            share_link: props.shareLink,
                            file_ids: [props.item.id],
                            password: props.password
                        })
                    });
                    const json = await res.json();
                    if (json.state) {
                        emit('notify', { message: '转存成功: ' + props.item.name, type: 'success' });
                    } else {
                        emit('notify', { message: '转存失败: ' + json.message, type: 'error' });
                    }
                } catch (e) {
                    emit('notify', { message: '请求失败: ' + e.message, type: 'error' });
                }
            };

            return { isOpen, loading, children, toggle, onSave, isISO, formatBytes };
        }
    });

    const CACHE_TTL = 8 * 60 * 60 * 1000;
    const cache = {
        get(key) {
            try {
                const item = localStorage.getItem(key);
                if (!item) return null;
                const parsed = JSON.parse(item);
                if (Date.now() - parsed.ts > CACHE_TTL) { localStorage.removeItem(key); return null; }
                return parsed.data;
            } catch (e) { return null; }
        },
        set(key, data) {
            try { localStorage.setItem(key, JSON.stringify({ ts: Date.now(), data: data })); } catch (e) {}
        }
    };
    const fetchWithCache = async (url) => {
        const cacheKey = `fullbr_v6_${url}`;
        const cached = cache.get(cacheKey);
        if (cached) return cached;
        const res = await fetch(url);
        if (!res.ok) throw new Error("API Error");
        const json = await res.json();
        cache.set(cacheKey, json);
        return json;
    };

    // Helper: Parse Size for Sorting
    const parseSize = (str) => {
        if (!str || typeof str !== 'string') return 0;
        const units = { 'B': 1, 'KB': 1024, 'MB': 1024**2, 'GB': 1024**3, 'TB': 1024**4, 'PB': 1024**5 };
        const match = str.match(/([\d.]+)\s*([a-zA-Z]+)/);
        if (!match) return 0;
        const val = parseFloat(match[1]);
        const unit = match[2].toUpperCase();
        return val * (units[unit] || 1);
    };

    const ResourcePanel = {
        template: '#resource-panel-template',
        components: { TreeNode },
        props: ['tmdbId', 'mediaType', 'seasonNumber', 'episodeNumber', 'availability', 'context', 'injected115'],
        emits: ['notify'],
        setup(props, { emit }) {
            const activeTab = ref('');
            const localResources = ref([]);
            const loading = ref(false);

            const tabs = computed(() => {
                const t = [];
                if ((props.injected115 && props.injected115.length > 0) || 
                    (props.mediaType === 'movie' && props.availability?.has_115)) {
                    t.push({ id: '115_share', label: '115分享', icon: 'fa-solid fa-cloud' });
                }
                const hasLocalMagnet = localResources.value.some(r => r.link_type === 'magnet');
                if (hasLocalMagnet || (props.mediaType === 'movie' && props.availability?.has_magnet)) {
                    t.push({ id: 'magnet', label: '磁力链', icon: 'fa-solid fa-magnet' });
                }
                const hasLocalEd2k = localResources.value.some(r => r.link_type === 'ed2k');
                if (hasLocalEd2k || (props.mediaType === 'movie' && props.availability?.has_ed2k)) {
                    t.push({ id: 'ed2k', label: '电驴/Ed2k', icon: 'fa-solid fa-network-wired' });
                }
                return t;
            });

            // Sorted Display Resources
            const displayResources = computed(() => {
                let list = [];
                if (props.mediaType === 'tv_episode') {
                    list = [...localResources.value];
                } else if (activeTab.value === '115_share' && props.mediaType !== 'movie') {
                    list = [...(props.injected115 || [])];
                } else {
                    list = localResources.value.filter(r => r.link_type === activeTab.value);
                }
                // Sort by Size Descending
                return list.sort((a, b) => parseSize(b.size) - parseSize(a.size));
            });

            const isIso = (res) => (res.title || res.name || '').toLowerCase().endsWith('.iso');
            const copyLink = (link) => navigator.clipboard.writeText(link).then(() => emit('notify', {message: '链接已复制', type:'success'})).catch(() => emit('notify', {message: '复制失败', type:'error'}));

            const addOfflineTask = async (url) => {
                if (!url) return;
                emit('notify', { message: '正在添加离线任务...', type: 'success' });
                try {
                    const res = await fetch('/p115/offline/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ urls: [url] })
                    });
                    const json = await res.json();
                    if (json.state) {
                        emit('notify', { message: '离线任务添加成功', type: 'success' });
                    } else {
                        emit('notify', { message: '任务添加失败: ' + json.message, type: 'error' });
                    }
                } catch (e) {
                    emit('notify', { message: '请求失败: ' + e.message, type: 'error' });
                }
            };

            const fetchLocalData = async () => {
                loading.value = true;
                localResources.value = [];
                try {
                    let url = '';
                    if (props.mediaType === 'movie') {
                        const params = new URLSearchParams();
                        if(activeTab.value) params.append('source_type', activeTab.value);
                        url = `/resources/movie/${props.tmdbId}?${params.toString()}`;
                        const data = await fetchWithCache(url);
                        localResources.value = data; 
                    } else if (props.mediaType === 'tv_season') {
                        url = `/resources/tv/${props.tmdbId}/season/${props.seasonNumber}`;
                        const data = await fetchWithCache(url);
                        localResources.value = data;
                    } else if (props.mediaType === 'tv_episode') {
                        url = `/resources/tv/${props.tmdbId}/season/${props.seasonNumber}/episode/${props.episodeNumber}`;
                        const data = await fetchWithCache(url);
                        localResources.value = data;
                    }
                } catch (e) { console.error(e); } 
                finally { loading.value = false; }
            };

            const updateActiveTab = () => {
                if (props.mediaType === 'tv_episode') return;
                const currentExists = tabs.value.find(t => t.id === activeTab.value);
                if (currentExists) return;
                if (tabs.value.length > 0) activeTab.value = tabs.value[0].id;
                else activeTab.value = '';
            };

            watch([() => props.injected115, localResources], () => updateActiveTab());
            watch(activeTab, () => { if (props.mediaType === 'movie') fetchLocalData(); });
            watch(() => [props.seasonNumber, props.episodeNumber], () => { localResources.value = []; fetchLocalData(); });

            onMounted(() => {
                if (props.mediaType === 'movie' && props.availability) {
                    if (props.availability.has_115) activeTab.value = '115_share';
                    else if (props.availability.has_magnet) activeTab.value = 'magnet';
                    else activeTab.value = 'ed2k';
                    fetchLocalData();
                } else {
                    fetchLocalData().then(() => updateActiveTab());
                }
            });

            return { activeTab, displayResources, tabs, loading, copyLink, isIso, addOfflineTask };
        }
    };

    createApp({
        components: { 'resource-panel': ResourcePanel },
        setup() {
            const currentView = ref('home');
            const isDark = ref(true);
            const showMobileSearch = ref(false);
            const loading = ref(false);
            const mediaType = ref('movie');
            const mediaList = ref([]);
            const genres = ref([]);
            const searchQuery = ref('');
            const currentPage = ref(1);
            const detailData = ref(null);
            
            const selectedSeasonNumber = ref(null);
            const currentSeasonData = ref(null);
            const raw115Resources = ref([]);
            
            // Refs for Scrolling
            const seasonTabsContainer = ref(null);
            const seasonTabsRefs = ref({});

            const showAdvancedFilters = ref(false);
            const filters = ref({ sortBy: 'popularity.desc', minVote: 0, minVoteCount: 100, selectedGenres: [], dateRange: null, originalLanguage: null });
            const showEpisodeModal = ref(false);
            const currentEpisode = ref({});

            // Toasts State
            const toasts = ref([]);
            let toastIdCounter = 0;

            const dateRanges = computed(() => {
                const ranges = [];
                ranges.push({ label: '1950前', start: '1900-01-01', end: '1949-12-31' });
                ranges.push({ label: '50s-60s', start: '1950-01-01', end: '1969-12-31' });
                ranges.push({ label: '70s-80s', start: '1970-01-01', end: '1989-12-31' });
                ranges.push({ label: '90s', start: '1990-01-01', end: '1999-12-31' });
                ranges.push({ label: '2000s', start: '2000-01-01', end: '2009-12-31' });
                ranges.push({ label: '2010s', start: '2010-01-01', end: '2019-12-31' });
                for (let y = 2020; y <= new Date().getFullYear(); y++) {
                    ranges.push({ label: `${y}`, start: `${y}-01-01`, end: `${y}-12-31` });
                }
                return ranges.reverse();
            });

            const languageOptions = [
                { label: '华语', code: 'zh' },
                { label: '英语', code: 'en' },
                { label: '日本', code: 'ja' },
                { label: '韩国', code: 'ko' },
                { label: '法国', code: 'fr' },
                { label: '德国', code: 'de' },
                { label: '西班牙', code: 'es' },
                { label: '泰国', code: 'th' },
                { label: '印度', code: 'hi' },
                { label: '俄罗斯', code: 'ru' }
            ];

            const toggleLanguage = (code) => {
                if (filters.value.originalLanguage === code) filters.value.originalLanguage = null;
                else filters.value.originalLanguage = code;
                currentPage.value = 1;
                refreshData();
            };

            const showToast = ({ message, type = 'success', duration = 3000 }) => {
                const id = toastIdCounter++;
                toasts.value.push({ id, message, type });
                setTimeout(() => removeToast(id), duration);
            };

            const removeToast = (id) => {
                const idx = toasts.value.findIndex(t => t.id === id);
                if (idx !== -1) toasts.value.splice(idx, 1);
            };

            const toggleTheme = () => {
                isDark.value = !isDark.value;
                if (isDark.value) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            };

            const loadGenres = async () => {
                 try { const data = await fetchWithCache(`/tmdb/genres/${mediaType.value}`); genres.value = data; } catch (e) {}
            };

            const buildQueryUrl = (base) => {
                const params = new URLSearchParams();
                params.append('page', currentPage.value);
                if (currentView.value === 'home') {
                    params.append('sort_by', filters.value.sortBy);
                    params.append('min_vote', filters.value.minVote);
                    params.append('min_vote_count', filters.value.minVoteCount);
                    if (filters.value.selectedGenres.length) params.append('with_genres', filters.value.selectedGenres.join(','));
                    if (filters.value.originalLanguage) params.append('with_original_language', filters.value.originalLanguage);
                    if (filters.value.dateRange) { params.append('start_date', filters.value.dateRange.start); params.append('end_date', filters.value.dateRange.end); }
                } else if (currentView.value === 'search') { params.append('query', searchQuery.value); }
                return `${base}?${params.toString()}`;
            };

            const refreshData = async () => {
                loading.value = true;
                mediaList.value = [];
                try {
                    let url = currentView.value === 'search' && searchQuery.value ? buildQueryUrl('/tmdb/search') : buildQueryUrl(`/tmdb/discover/${mediaType.value}`);
                    if (url.includes('search') && !searchQuery.value) return;
                    const res = await fetchWithCache(url);
                    mediaList.value = res.results || [];
                } finally { loading.value = false; }
            };

            const switchMediaType = (type) => { mediaType.value = type; currentPage.value = 1; filters.value.selectedGenres = []; loadGenres(); refreshData(); };
            const toggleGenre = (id) => { const idx = filters.value.selectedGenres.indexOf(id); if (idx > -1) filters.value.selectedGenres.splice(idx, 1); else filters.value.selectedGenres.push(id); currentPage.value = 1; refreshData(); };
            const toggleDateRange = (range) => { if (filters.value.dateRange?.label === range.label) filters.value.dateRange = null; else filters.value.dateRange = range; currentPage.value = 1; refreshData(); };
            const changePage = (d) => { currentPage.value += d; refreshData(); };
            const performSearch = () => { if(!searchQuery.value) return; currentView.value = 'search'; currentPage.value = 1; showMobileSearch.value = false; refreshData(); };
            const goHome = () => { currentView.value = 'home'; searchQuery.value = ''; currentPage.value = 1; refreshData(); };
            const goBack = () => { currentView.value = searchQuery.value ? 'search' : 'home'; };

            const goToDetail = async (id, type) => {
                loading.value = true;
                detailData.value = null;
                currentSeasonData.value = null;
                selectedSeasonNumber.value = null;
                raw115Resources.value = [];
                seasonTabsRefs.value = {}; 

                try {
                    const targetType = type || mediaType.value;
                    const data = await fetchWithCache(`/tmdb/details/${targetType}/${id}`);
                    detailData.value = data;
                    currentView.value = 'detail';

                    if (targetType === 'tv') {
                        fetchWithCache(`/resources/tv/${id}`).then(res => { raw115Resources.value = res || []; });
                        if (data.seasons?.length) {
                            const first = data.seasons.find(s => s.season_number === 1) || data.seasons[0];
                            selectSeason(first);
                        }
                    }
                } catch(e) { console.error(e); } 
                finally { loading.value = false; }
            };

            const selectSeason = async (season) => {
                selectedSeasonNumber.value = season.season_number;
                currentSeasonData.value = null;
                
                await nextTick();
                const el = seasonTabsRefs.value[season.season_number];
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }

                try {
                    const data = await fetchWithCache(`/tmdb/details/tv/${detailData.value.tmdb_id}/season/${season.season_number}`);
                    currentSeasonData.value = data;
                } catch(e) {}
            };

            const fullSeries115 = computed(() => {
                if (!detailData.value || !detailData.value.seasons || raw115Resources.value.length === 0) return [];
                const validSeasons = detailData.value.seasons.filter(s => s.season_number > 0).map(s => `S${s.season_number}`);
                if (validSeasons.length === 0) return [];
                return raw115Resources.value.filter(res => {
                    if (!res.season_list) return false;
                    return validSeasons.every(s => res.season_list.includes(s));
                });
            });

            const getCurrentSeason115 = (seasonNum) => {
                if (raw115Resources.value.length === 0) return [];
                
                const fullSeriesLinks = new Set(fullSeries115.value.map(r => r.link));
                const targetS = `S${seasonNum}`;
                const validSeasonsCount = detailData.value.seasons.filter(s => s.season_number > 0).length;

                return raw115Resources.value.filter(res => {
                    return res.season_list && res.season_list.includes(targetS) && !fullSeriesLinks.has(res.link);
                }).map(res => {
                    const newRes = { ...res };
                    const isFull = (newRes.season_list.length >= validSeasonsCount); 
                    if (!isFull) {
                        const nums = newRes.season_list.map(s => parseInt(s.replace('S',''))).filter(n => !isNaN(n)).sort((a,b) => a-b);
                        if (nums.length > 0) {
                            const isContinuous = nums.every((val, i) => i === 0 || val === nums[i-1] + 1);
                            if (isContinuous && nums.length > 1) newRes.season_tag = `包含 S${nums[0]}-S${nums[nums.length-1]}`;
                            else if (nums.length === 1) newRes.season_tag = `仅包含 S${nums[0]}`;
                            else newRes.season_tag = `包含 ${newRes.season_list.join(',')}`;
                        }
                    }
                    return newRes;
                });
            };

            const openEpisodeModal = (seasonNum, episode) => {
                currentEpisode.value = { ...episode, season_number: seasonNum };
                showEpisodeModal.value = true;
            };
            const closeEpisodeModal = () => showEpisodeModal.value = false;

            onMounted(() => {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    isDark.value = true;
                    document.documentElement.classList.add('dark');
                } else { isDark.value = false; }
                loadGenres();
                refreshData();
            });

            return {
                currentView, isDark, toggleTheme, mediaType, switchMediaType, mediaList, loading,
                searchQuery, performSearch, goHome, goBack, currentPage, changePage,
                filters, genres, dateRanges, refreshData, showAdvancedFilters, toggleGenre, toggleDateRange, languageOptions, toggleLanguage,
                goToDetail, detailData,
                selectedSeasonNumber, currentSeasonData, selectSeason,
                showEpisodeModal, openEpisodeModal, closeEpisodeModal, currentEpisode, showMobileSearch,
                fullSeries115, getCurrentSeason115,
                seasonTabsContainer, seasonTabsRefs,
                toasts, showToast, removeToast
            };
        }
    }).mount('#app');
</script>
</body>
</html>